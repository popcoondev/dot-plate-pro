# Dot Plate Pro - 開発ハンドオフ・ドキュメント

## 1. プロジェクト概要

画像から積層構造を持つ3Dモデル（ドットプレート）を生成・編集し、STL形式または高解像度画像として出力するモバイル最適化Webアプリケーション。

## 2. 技術スタック

*   **Frontend**: React (Functional Components, Hooks)
*   **3D Rendering**: Three.js (OrbitControls, STLExporter)
*   **Icons**: Lucide React
*   **Styling**: Tailwind CSS v4
*   **Build Tool**: Vite (推奨) / Firebase Hosting (公開用)

## 3. デザインシステム（UI/UX）

現状の「モダン・プレミアム・クリエイティブ」なデザインを踏襲してください。

*   **テーマカラー**: Indigo (#4f46e5) をアクセントに使用。背景は Slate 50。
*   **形状**: コンテナやボタンには `rounded-[1.5rem]` 〜 `rounded-[2.5rem]` の大きな角丸を適用。
*   **質感**: `backdrop-blur-md` と `bg-white/80` 等を組み合わせた透過レイヤーを活用。
*   **モバイル最適化**:
    *   フローティングツールバー（水平スクロール対応）。
    *   コンパクトなナビゲーションバー（最下部）。
    *   解像度操作エリアは2行構成（ラベル/ボタン行 + スライダー行）。

## 4. コアロジックと仕様

### 4.1 キャンバス編集

*   **透過色**: `[255, 0, 255]` (Magenta) を透明として扱う。3D化の際は「空洞」になる。
*   **履歴**: `pixels` 配列をJSON文字列化して `history` ステートで管理（最大15回）。
*   **座標系**: 常に中心 `(0,0)` を原点としてモデリング・描画を計算。

### 4.2 バーチャルパッド (Gamepad Mode)

*   トラックパッドエリアでの相対移動を `cursorSubPixelRef` で保持し、整数座標に丸めて `cursorPos` を更新。
*   十字のガイドラインを表示し、背景は透過。

### 4.3 3Dモデリング

*   **高さ計算**: `(baseThickness + (layerIndex + 1) * layerThickness)`
*   **レイヤー管理**: `layerOrder` 配列のインデックスがそのまま積層順（Z軸の高さ）に対応。上下ボタンでスワップ操作を行う。

### 4.4 エクスポート

*   **STL**: `STLExporter` を使用したバイナリ出力。
*   **画像**: iPhoneでのメモリクラッシュを避けるため、`setTimeout` を挟んだ非同期分割レンダリングを実行。300DPI相当のサイズ。

## 5. 開発上の注意点（制約事項）

*   **シングルファイル原則**: 全てのコンポーネント、ロジック、スタイルは `App.jsx` 1ファイル内に完結させること（環境制約のため）。
*   **モバイル優先**: iPhone等の小画面デバイスでツールバーやボタンが重ならないよう、常にレスポンシブな設計を維持すること。
*   **メモリ管理**: 巨大なグリッド（最大500x500）を扱うため、不要な再レンダリングを `useCallback` や `useRef` で抑制すること。

## 6. 今後の開発課題（Roadmap）

### フェーズ1：モバイルファーストの操作感改善

*   [ ] **ペン操作の干渉解消**: バーチャルパッドOFF時のタッチ操作において、キャンバスのスクロールとペン描画が競合し、キャンバスごと動いてしまう問題を修正。
*   [ ] **プレート作成用補助機能の追加**: 以下の2つの独自ツールを実装。
    *   **アイランド塗りつぶし**: プロットした座標から経路探索を行い、繋がっている「透過色以外のドット」をすべて現在の色で塗りつぶす機能。
    *   **オート・アウトライン**: プロットした座標から経路探索で絵柄の境界にある透過色を探し、その透過色を1ドット分だけ塗ることで、絵柄の外側を縁取る機能。

### フェーズ2：アーキテクチャの整理（リファクタリング）

*   [ ] **ソースコードの分割**: 現在の `App.jsx` 1ファイル構成を、コンポーネント、フック、ロジックごとに分離。現在の仕様とデザインを完全に維持したまま、保守性の高いマルチファイル構成へリファクタリング。

### フェーズ3：クラウドシフト

*   [ ] **Firebase / GCP 移行**: クラウド保存機能の搭載。
*   [ ] **サーバーサイド機能の実装**: クラウド上でのデータ管理とユーザー間共有の基盤構築。
